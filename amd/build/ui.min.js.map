{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny edu-sharing Content configuration.\n *\n * @module      tiny_edusharing/commands\n * @copyright   2022 metaVentis GmbH <http://metaventis.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {component} from './common';\nimport {getRepoUrl, getRepoTarget, getCourseId} from './options';\n\nimport {renderForPromise} from 'core/templates';\nimport Modal from 'tiny_edusharing/modal';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport {getTicket} from \"./repository\";\n\nlet openingSelection = null;\n\nexport const handleAction = (editor) => {\n    openingSelection = editor.selection.getBookmark();\n    displayDialogue(editor);\n};\n\nconst handleDialogueSubmission = async(editor) => {\n    const nodeJson = window.document.getElementById('edusharing_node').value;\n    const node = JSON.parse(nodeJson);\n    const version = window.document.querySelector('input[name=\"eduVersion\"]:checked').value;\n    const caption = window.document.getElementById('captionInput').value;\n    const alignment = window.document.querySelector('input[name=\"eduAlignment\"]:checked').value;\n    const width = window.document.getElementById('eduWidth').value;\n    const height = window.document.getElementById('eduHeight').value;\n\n\n    let style = '';\n    if (alignment !== 'none') {\n        style = 'float:' + node.alignment + ';';\n    }\n    if (node.mediatype === 'folder') {\n        style = 'display:block;';\n    }\n\n    let title = node.title || node.name;\n\n    let url = new URL(node.previewUrl);\n    url.searchParams.set('caption', caption);\n    url.searchParams.set('object_url', node.objectUrl);\n    url.searchParams.set('mediatype', node.mediatype);\n    url.searchParams.set('mimetype', node.mimetype);\n    url.searchParams.set('window_version', version);\n    url.searchParams.set('title', title);\n\n    let img = false;\n    let ref = false;\n\n    if (node.mediatype === 'ref') {\n        ref = true;\n    } else {\n        img = true;\n        url.searchParams.set('width', width.toString());\n        url.searchParams.set('height', height.toString());\n    }\n\n    const content = await renderForPromise(`${component}/content`, {\n        edusharingImg: img,\n        edusharingRef: ref,\n        edusharingPreviewSrc: url.toString(),\n        edusharingTitle: title.toString(),\n        edusharingCaption: caption.toString(),\n        edusharingWidth: width.toString(),\n        edusharingHeight: height.toString(),\n        edusharingStyle: style\n    });\n\n    editor.selection.moveToBookmark(openingSelection);\n    editor.execCommand('mceInsertContent', false, content.html);\n    editor.selection.moveToBookmark(openingSelection);\n};\n\nconst getCurrentEdusharingData = (currentEdusharing) => {\n    const data = {};\n    let node;\n    try {\n        node = currentEdusharing.textContent;\n    } catch (error) {\n        return data;\n    }\n    data.node = node.toString();\n\n    return data;\n};\n\nconst displayDialogue = async(editor, data = {}) => {\n    const selection = editor.selection.getNode();\n    const currentEdusharing = selection.closest('.edusharing-placeholder');\n    if (currentEdusharing) {\n        window.console.log(currentEdusharing);\n        Object.assign(data, getCurrentEdusharingData(currentEdusharing));\n    }\n\n    const modal = await ModalFactory.create({\n        type: Modal.TYPE,\n        large: true,\n        removeOnClose: true\n    });\n    modal.show();\n\n    const $root = modal.getRoot();\n    const root = $root[0];\n    $root.on(ModalEvents.save, () => {\n        handleDialogueSubmission(editor);\n    });\n    root.addEventListener('click', (e) => {\n        const openRepoButton = e.target.closest('[data-target=\"edusharing\"]');\n        if (openRepoButton) {\n            const repoUrl = getRepoUrl(editor);\n            openRepo(repoUrl, getRepoTarget(editor), getCourseId(editor));\n            window.addEventListener(\"message\", function(event) {\n                if (event.data.event === \"APPLY_NODE\") {\n                    const node = event.data.data;\n                    const width = Math.round(node.properties['ccm:width'][0]) || 600;\n                    const height = Math.round(node.properties['ccm:height'][0]) || 400;\n                    window.win.close();\n                    window.console.log(node);\n                    checkVersioning(node);\n                    window.document.getElementById('repoButtonContainer').classList.add('d-none');\n                    window.document.getElementById('nodeOptionsForm').classList.remove('d-none');\n                    window.document.getElementById('eduContentTitle').innerHTML = node.name || node.title;\n                    window.document.getElementById('eduPreviewImage')\n                        .setAttribute('src', node.preview.url);\n                    initSizeCalculation(width, height);\n                    setNodeData(node);\n                    window.document.getElementById('eduSubmitButton').disabled = false;\n                }\n            });\n        }\n    });\n};\n\nconst initSizeCalculation = (width, height) => {\n    if (width === 0 || height === 0) {\n        return;\n    }\n    const aspectRatio = width / height;\n    const heightInput = window.document.getElementById('eduHeight');\n    const widthInput = window.document.getElementById('eduWidth');\n    widthInput.value = width;\n    heightInput.value = height;\n    widthInput.addEventListener('keyup', event => recalculateDimensions(event));\n    widthInput.addEventListener('change', event => recalculateDimensions(event));\n    heightInput.addEventListener('keyup', event => recalculateDimensions(event));\n    heightInput.addEventListener('change', event => recalculateDimensions(event));\n    const recalculateDimensions = (event) => {\n        if (event.target.id === 'eduHeight') {\n            widthInput.value = Math.round(heightInput.value * aspectRatio);\n        } else {\n            heightInput.value = Math.round(widthInput.value / aspectRatio);\n        }\n    };\n};\n\nconst checkVersioning = (node) => {\n    if (node.aspects.includes('ccm:published') || node.aspects.includes('ccm:collection_io_reference')) {\n        window.document.querySelectorAll(\".eduVersionRadio\")\n            .forEach(item => item.classList.add('d-none'));\n    }\n    window.document.getElementById('eduversion2').value = node.properties['cclom:version'][0];\n};\n\nconst setNodeData = node => {\n    const nodeData = {\n        mimetype: node.mimetype,\n        mediatype: node.mediatype,\n        title: node.title,\n        objectUrl: node.objectUrl,\n        name: node.name,\n        previewUrl: node.preview.url\n    };\n    window.document.getElementById('edusharing_node').value = JSON.stringify(nodeData);\n};\n\nconst openRepo = (repoUrl, repoTarget, courseId) => {\n    window.win = window.open();\n    window.win.document.write('Loading edu-sharing ticket...');\n    switch (repoTarget) {\n        case 'collections':\n            repoTarget = '/components/collections';\n            break;\n        case 'workspace':\n            repoTarget = '/components/workspace/files';\n            break;\n        default:\n            repoTarget = '/components/search';\n    }\n    const ajaxParams = {\n        eduTicketStructure: {\n            courseId: courseId\n        }\n    };\n    getTicket(ajaxParams)\n        .then(response => {\n            repoUrl += repoTarget + '?reurl=WINDOW&applyDirectories=true&ticket=' + response.ticket;\n            window.win.location.href = repoUrl;\n            return null;\n        })\n        .fail(() => window.document.write('Error loading ticket.'));\n};"],"names":["openingSelection","editor","selection","getBookmark","displayDialogue","handleDialogueSubmission","async","nodeJson","window","document","getElementById","value","node","JSON","parse","version","querySelector","caption","alignment","width","height","style","mediatype","title","name","url","URL","previewUrl","searchParams","set","objectUrl","mimetype","img","ref","toString","content","component","edusharingImg","edusharingRef","edusharingPreviewSrc","edusharingTitle","edusharingCaption","edusharingWidth","edusharingHeight","edusharingStyle","moveToBookmark","execCommand","html","getCurrentEdusharingData","currentEdusharing","data","textContent","error","getNode","closest","console","log","Object","assign","modal","ModalFactory","create","type","Modal","TYPE","large","removeOnClose","show","$root","getRoot","root","on","ModalEvents","save","addEventListener","e","target","repoUrl","openRepo","event","Math","round","properties","win","close","checkVersioning","classList","add","remove","innerHTML","setAttribute","preview","initSizeCalculation","setNodeData","disabled","aspectRatio","heightInput","widthInput","recalculateDimensions","id","aspects","includes","querySelectorAll","forEach","item","nodeData","stringify","repoTarget","courseId","open","write","ajaxParams","eduTicketStructure","then","response","ticket","location","href","fail"],"mappings":"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"}