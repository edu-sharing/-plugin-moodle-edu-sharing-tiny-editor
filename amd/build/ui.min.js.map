{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny edu-sharing Content configuration.\n *\n * @module      tiny_edusharing/commands\n * @copyright   2022 metaVentis GmbH <http://metaventis.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {component} from './common';\nimport {getRepoUrl, getRepoTarget, getCourseId} from './options';\n\nimport {renderForPromise} from 'core/templates';\nimport Modal from 'tiny_edusharing/modal';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport {getTicket} from \"./repository\";\nimport Config from 'core/config';\n\nlet openingSelection = null;\n\nexport const handleAction = (editor) => {\n    openingSelection = editor.selection.getBookmark();\n    displayDialogue(editor);\n};\n\nexport const initInstructionGif = () => {\n    const gif = window.document.getElementById('eduInstructionGif');\n    const relativePath = gif.getAttribute('src');\n    const absolutePath = Config.wwwroot + relativePath;\n    gif.setAttribute('src', absolutePath);\n};\n\nconst handleDialogueSubmission = async(editor) => {\n    const nodeJson = window.document.getElementById('edusharing_node').value;\n    const node = JSON.parse(nodeJson);\n    const version = window.document.querySelector('input[name=\"eduVersion\"]:checked').value;\n    const caption = window.document.getElementById('captionInput').value;\n    const alignment = window.document.querySelector('input[name=\"eduAlignment\"]:checked').value;\n    const width = window.document.getElementById('eduWidth').value;\n    const height = window.document.getElementById('eduHeight').value;\n\n\n    let style = '';\n    if (alignment !== 'none') {\n        style = 'float:' + alignment + ';';\n    }\n    if (node.mediatype === 'folder') {\n        style = 'display:block;';\n    }\n\n    let title = node.title || node.name;\n\n    let url = new URL(node.previewUrl);\n    url.searchParams.set('caption', caption);\n    url.searchParams.set('object_url', node.objectUrl);\n    url.searchParams.set('mediatype', node.mediatype);\n    url.searchParams.set('mimetype', node.mimetype);\n    url.searchParams.set('window_version', version);\n    url.searchParams.set('title', title);\n\n    let img = false;\n    let ref = false;\n\n    if (node.mediatype === 'ref') {\n        ref = true;\n    } else {\n        img = true;\n        url.searchParams.set('width', width.toString());\n        url.searchParams.set('height', height.toString());\n    }\n\n    const content = await renderForPromise(`${component}/content`, {\n        edusharingImg: img,\n        edusharingRef: ref,\n        edusharingPreviewSrc: url.toString(),\n        edusharingTitle: title.toString(),\n        edusharingCaption: caption.toString(),\n        edusharingWidth: width.toString(),\n        edusharingHeight: height.toString(),\n        edusharingStyle: style\n    });\n\n    editor.selection.moveToBookmark(openingSelection);\n    editor.execCommand('mceInsertContent', false, content.html);\n    editor.selection.moveToBookmark(openingSelection);\n};\n\nconst getCurrentEdusharingData = (currentEdusharing) => {\n    const data = {};\n    let node;\n    try {\n        node = currentEdusharing.textContent;\n    } catch (error) {\n        return data;\n    }\n    data.node = node.toString();\n\n    return data;\n};\n\nconst displayDialogue = async(editor, data = {}) => {\n    const selection = editor.selection.getNode();\n    const currentEdusharing = selection.closest('.edusharing-placeholder');\n    if (currentEdusharing) {\n        Object.assign(data, getCurrentEdusharingData(currentEdusharing));\n    }\n\n    const modal = await ModalFactory.create({\n        type: Modal.TYPE,\n        large: true,\n        removeOnClose: true\n    });\n    modal.show();\n\n    const $root = modal.getRoot();\n    const root = $root[0];\n    $root.on(ModalEvents.save, () => {\n        handleDialogueSubmission(editor);\n    });\n    root.addEventListener('click', (e) => {\n        const openRepoButton = e.target.closest('[data-target=\"edusharing\"]');\n        if (openRepoButton) {\n            const repoUrl = getRepoUrl(editor);\n            openRepo(repoUrl, getRepoTarget(editor), getCourseId(editor));\n            window.addEventListener(\"message\", function(event) {\n                if (event.data.event === \"APPLY_NODE\") {\n                    const node = event.data.data;\n                    const width = node.properties['ccm:width'] !== undefined ? Math.round(node.properties['ccm:width'][0]) : 600;\n                    const height = node.properties['ccm:height'] !== undefined ? Math.round(node.properties['ccm:height'][0]) : 400;\n                    window.win.close();\n                    checkVersioning(node);\n                    window.document.getElementById('repoButtonContainer').classList.add('d-none');\n                    window.document.getElementById('nodeOptionsForm').classList.remove('d-none');\n                    window.document.getElementById('eduContentTitle').innerHTML = node.name ?? node.title;\n                    window.document.getElementById('eduPreviewImage')\n                        .setAttribute('src', node.preview.url);\n                    hideSizeOptions(node.mediatype);\n                    initSizeCalculation(width, height);\n                    setNodeData(node);\n                    window.document.getElementById('eduSubmitButton').disabled = false;\n                }\n            });\n        }\n    });\n};\n\nconst hideSizeOptions = mediaType => {\n    if (mediaType === 'file-pdf' || mediaType === 'file-odt') {\n        window.document.getElementById('eduWidthContainer').classList.add('d-none');\n    }\n};\n\nconst initSizeCalculation = (width, height) => {\n    if (width === 0 || height === 0) {\n        return;\n    }\n    const aspectRatio = width / height;\n    const heightInput = window.document.getElementById('eduHeight');\n    const widthInput = window.document.getElementById('eduWidth');\n    widthInput.value = width;\n    heightInput.value = height;\n    widthInput.addEventListener('keyup', event => recalculateDimensions(event));\n    widthInput.addEventListener('change', event => recalculateDimensions(event));\n    heightInput.addEventListener('keyup', event => recalculateDimensions(event));\n    heightInput.addEventListener('change', event => recalculateDimensions(event));\n    const recalculateDimensions = (event) => {\n        if (event.target.id === 'eduHeight') {\n            widthInput.value = Math.round(heightInput.value * aspectRatio);\n        } else {\n            heightInput.value = Math.round(widthInput.value / aspectRatio);\n        }\n    };\n};\n\nconst checkVersioning = (node) => {\n    if (node.aspects.includes('ccm:published') || node.aspects.includes('ccm:collection_io_reference')) {\n        window.document.querySelectorAll(\".eduVersionRadio\")\n            .forEach(item => item.classList.add('d-none'));\n    }\n    window.document.getElementById('eduversion2').value = node.properties['cclom:version'][0];\n};\n\nconst setNodeData = node => {\n    const nodeData = {\n        mimetype: node.mimetype,\n        mediatype: node.mediatype,\n        title: node.title,\n        objectUrl: node.objectUrl,\n        name: node.name,\n        previewUrl: node.preview.url\n    };\n    window.document.getElementById('edusharing_node').value = JSON.stringify(nodeData);\n};\n\nconst openRepo = (repoUrl, repoTarget, courseId) => {\n    window.win = window.open();\n    window.win.document.write('Loading edu-sharing ticket...');\n    switch (repoTarget) {\n        case 'collections':\n            repoTarget = '/components/collections';\n            break;\n        case 'workspace':\n            repoTarget = '/components/workspace/files';\n            break;\n        default:\n            repoTarget = '/components/search';\n    }\n    const ajaxParams = {\n        eduTicketStructure: {\n            courseId: courseId\n        }\n    };\n    getTicket(ajaxParams)\n        .then(response => {\n            repoUrl += repoTarget + '?reurl=WINDOW&applyDirectories=true&ticket=' + response.ticket;\n            window.win.location.href = repoUrl;\n            return null;\n        })\n        .fail(() => window.document.write('Error loading ticket.'));\n};\n"],"names":["openingSelection","editor","selection","getBookmark","displayDialogue","gif","window","document","getElementById","relativePath","getAttribute","absolutePath","Config","wwwroot","setAttribute","handleDialogueSubmission","async","nodeJson","value","node","JSON","parse","version","querySelector","caption","alignment","width","height","style","mediatype","title","name","url","URL","previewUrl","searchParams","set","objectUrl","mimetype","img","ref","toString","content","component","edusharingImg","edusharingRef","edusharingPreviewSrc","edusharingTitle","edusharingCaption","edusharingWidth","edusharingHeight","edusharingStyle","moveToBookmark","execCommand","html","getCurrentEdusharingData","currentEdusharing","data","textContent","error","getNode","closest","Object","assign","modal","ModalFactory","create","type","Modal","TYPE","large","removeOnClose","show","$root","getRoot","root","on","ModalEvents","save","addEventListener","e","target","repoUrl","openRepo","event","undefined","properties","Math","round","win","close","checkVersioning","classList","add","remove","innerHTML","preview","hideSizeOptions","initSizeCalculation","setNodeData","disabled","mediaType","aspectRatio","heightInput","widthInput","recalculateDimensions","id","aspects","includes","querySelectorAll","forEach","item","nodeData","stringify","repoTarget","courseId","open","write","ajaxParams","eduTicketStructure","then","response","ticket","location","href","fail"],"mappings":"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"}