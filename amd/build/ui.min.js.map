{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny edu-sharing Content configuration.\n *\n * @module      tiny_edusharing/commands\n * @copyright   2022 metaVentis GmbH <http://metaventis.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {component} from './common';\nimport {getRepoUrl, getRepoTarget, getCourseId} from './options';\n\nimport {getList} from 'core/normalise';\nimport {renderForPromise} from 'core/templates';\nimport Modal from 'tiny_edusharing/modal';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport Config from 'core/config';\n\nlet openingSelection = null;\n\nexport const handleAction = (editor) => {\n    openingSelection = editor.selection.getBookmark();\n    displayDialogue(editor);\n};\n\nconst handleDialogueSubmission = async(editor, modal, data) => {\n    const form = getList(modal.getRoot())[0].querySelector('form');\n    if (!form) {\n        // The form couldn't be found, which is weird.\n        // This should not happen.\n        // Display the dialogue again\n        displayDialogue(editor, Object.assign({}, data));\n        return;\n    }\n\n    // Get the URL from the submitted form.\n    const node = JSON.parse(form.querySelector('input[name=\"edusharing_node\"]').value);\n\n    console.log('node:');\n    console.log(node);\n\n    if (!node) {\n        // The node is invalid.\n        // Fill it in and represent the dialogue with an error.\n        displayDialogue(editor, Object.assign({}, data, {\n            edusharing_node: node,\n            invalidUrl: true,\n        }));\n        return;\n    }\n\n\n    let style = '';\n    if (node.alignment != 'none') {\n        style = 'float:' + node.alignment + ';';\n    }\n    if (node.mediatype == 'folder') {\n        style = 'display:block;';\n    }\n    let version = '0';\n    if (false == node.showlatest && node.version != 'undefined') {\n        version = node.version;\n    }\n    let insert = 'class=\"edusharing_atto\" ' +\n        'style=\"' + style + '\" ' +\n        'title=\"' + node.title + '\" ';\n\n    let title = node.title || node.name;\n    let caption = node.caption || '';\n\n    let url = new URL(node.preview.url);\n    url.searchParams.set('caption', caption);\n    url.searchParams.set('object_url', node.objecturl);\n    url.searchParams.set('mediatype', node.mediatype);\n    url.searchParams.set('mimetype', node.mimetype);\n    url.searchParams.set('window_version', version);\n    url.searchParams.set('title', title);\n\n    let width = Math.round(node.properties['ccm:width']) || 600; // Current image width\n    let height = Math.round(node.properties['ccm:height']) || 400; // Current image height\n\n    let img, ref = false;\n\n    if (node.mediatype == 'ref') {\n        ref = true;\n    } else {\n        img = true;\n        url.searchParams.set('width', width.toString());\n        url.searchParams.set('height', height.toString());\n    }\n\n    const content = await renderForPromise(`${component}/content`, {\n        edusharing_img: img,\n        edusharing_ref: ref,\n        edusharing_preview_src: url.toString(),\n        edusharing_title: title.toString(),\n        edusharing_caption: caption.toString(),\n        edusharing_width: width.toString(),\n        edusharing_height: height.toString(),\n    });\n\n    editor.selection.moveToBookmark(openingSelection);\n    editor.execCommand('mceInsertContent', false, content.html);\n    editor.selection.moveToBookmark(openingSelection);\n};\n\nconst getCurrentEdusharingData = (currentEdusharing) => {\n    const data = {};\n    let node;\n    try {\n        node = currentEdusharing.textContent;\n    } catch (error) {\n        return data;\n    }\n\n\n    data.node = node.toString();\n\n    return data;\n};\n\nconst displayDialogue = async(editor, data = {}) => {\n    const selection = editor.selection.getNode();\n    const currentEdusharing = selection.closest('.edusharing-placeholder');\n    if (currentEdusharing) {\n        Object.assign(data, getCurrentEdusharingData(currentEdusharing));\n    }\n\n    const modal = await ModalFactory.create({\n        type: Modal.TYPE,\n        large: true,\n    });\n    modal.show();\n\n    const $root = modal.getRoot();\n    const root = $root[0];\n    $root.on(ModalEvents.save, (event, modal) => {\n        handleDialogueSubmission(editor, modal, data);\n    });\n\n    root.addEventListener('click', (e) => {\n        const openRepoButton = e.target.closest('[data-target=\"edusharing\"]');\n        if (openRepoButton) {\n            const repoUrl = getRepoUrl(editor);\n            open_repo(repoUrl, getRepoTarget(editor), getCourseId(editor));\n\n            window.addEventListener(\"message\", function(event) {\n                if (event.data.event == \"APPLY_NODE\") {\n                    const node = event.data.data;\n                    window.win.close();\n                    console.log(node);\n                    document.getElementById('edusharing-content').innerHTML = node.title;\n                    document.getElementById('edusharing_node').value = JSON.stringify(node);\n\n                }\n            }, false);\n        }\n    });\n};\n\nconst open_repo = function(repoUrl, repoTarget, courseId) {\n\n    window.win = window.open();\n    window.win.document.write('Loading edu-sharing ticket...');\n\n    var fetchUrl = `${Config.wwwroot}/lib/editor/tiny/plugins/edusharing/fetch.php`;\n\n    switch (repoTarget) {\n        case 'search':\n            repoTarget = '/components/search';\n            break;\n        case 'collections':\n            repoTarget = '/components/collections';\n            break;\n        case 'workspace':\n            repoTarget = '/components/workspace/files';\n            break;\n        default:\n            repoTarget = '/components/search';\n    }\n\n    // Fetch ticket\n    fetch(fetchUrl, {\n        method: 'post',\n        mode:    'cors',\n        headers: {\n            'Content-Type': 'application/json', // Sent request\n            'Accept':       'application/json' // Expected data sent back\n        },\n        body: JSON.stringify({\n            useCase: 'getTicket',\n            courseid: courseId\n        })\n    })\n        .then(function(response) {\n            if (response.status >= 200 && response.status < 300) {\n                return response.text();\n            }\n            throw new Error(response.statusText);\n        })\n        .then(function(response) {\n            var ticket = response;\n            repoUrl += repoTarget + '?reurl=WINDOW&applyDirectories=true&ticket=' + ticket;\n            // Window.win = window.open(repoUrl);\n            window.win.location.href = repoUrl;\n        });\n};"],"names":["openingSelection","editor","selection","getBookmark","displayDialogue","handleDialogueSubmission","async","modal","data","form","getRoot","querySelector","Object","assign","node","JSON","parse","value","console","log","edusharing_node","invalidUrl","style","alignment","mediatype","version","showlatest","title","name","caption","url","URL","preview","searchParams","set","objecturl","mimetype","img","width","Math","round","properties","height","ref","toString","content","component","edusharing_img","edusharing_ref","edusharing_preview_src","edusharing_title","edusharing_caption","edusharing_width","edusharing_height","moveToBookmark","execCommand","html","getCurrentEdusharingData","currentEdusharing","textContent","error","getNode","closest","ModalFactory","create","type","Modal","TYPE","large","show","$root","root","on","ModalEvents","save","event","addEventListener","e","target","repoUrl","open_repo","window","win","close","document","getElementById","innerHTML","stringify","repoTarget","courseId","open","write","fetchUrl","Config","wwwroot","fetch","method","mode","headers","body","useCase","courseid","then","response","status","text","Error","statusText","location","href"],"mappings":";;;;;;;sRAiCIA,iBAAmB,2BAEMC,SACzBD,iBAAmBC,OAAOC,UAAUC,cACpCC,gBAAgBH,eAGdI,yBAA2BC,MAAML,OAAQM,MAAOC,cAC5CC,MAAO,sBAAQF,MAAMG,WAAW,GAAGC,cAAc,YAClDF,iBAIDL,gBAAgBH,OAAQW,OAAOC,OAAO,GAAIL,aAKxCM,KAAOC,KAAKC,MAAMP,KAAKE,cAAc,iCAAiCM,UAE5EC,QAAQC,IAAI,SACZD,QAAQC,IAAIL,OAEPA,iBAGDV,gBAAgBH,OAAQW,OAAOC,OAAO,GAAIL,KAAM,CAC5CY,gBAAiBN,KACjBO,YAAY,SAMhBC,MAAQ,GACU,QAAlBR,KAAKS,YACLD,MAAQ,SAAWR,KAAKS,UAAY,KAElB,UAAlBT,KAAKU,YACLF,MAAQ,sBAERG,QAAU,IACV,GAASX,KAAKY,YAA8B,aAAhBZ,KAAKW,UACjCA,QAAUX,KAAKW,SAIHX,KAAKa,UAEjBA,MAAQb,KAAKa,OAASb,KAAKc,KAC3BC,QAAUf,KAAKe,SAAW,GAE1BC,IAAM,IAAIC,IAAIjB,KAAKkB,QAAQF,KAC/BA,IAAIG,aAAaC,IAAI,UAAWL,SAChCC,IAAIG,aAAaC,IAAI,aAAcpB,KAAKqB,WACxCL,IAAIG,aAAaC,IAAI,YAAapB,KAAKU,WACvCM,IAAIG,aAAaC,IAAI,WAAYpB,KAAKsB,UACtCN,IAAIG,aAAaC,IAAI,iBAAkBT,SACvCK,IAAIG,aAAaC,IAAI,QAASP,WAK1BU,IAHAC,MAAQC,KAAKC,MAAM1B,KAAK2B,WAAW,eAAiB,IACpDC,OAASH,KAAKC,MAAM1B,KAAK2B,WAAW,gBAAkB,IAEjDE,KAAM,EAEO,OAAlB7B,KAAKU,UACLmB,KAAM,GAENN,KAAM,EACNP,IAAIG,aAAaC,IAAI,QAASI,MAAMM,YACpCd,IAAIG,aAAaC,IAAI,SAAUQ,OAAOE,mBAGpCC,cAAgB,yCAAoBC,8BAAqB,CAC3DC,eAAgBV,IAChBW,eAAgBL,IAChBM,uBAAwBnB,IAAIc,WAC5BM,iBAAkBvB,MAAMiB,WACxBO,mBAAoBtB,QAAQe,WAC5BQ,iBAAkBd,MAAMM,WACxBS,kBAAmBX,OAAOE,aAG9B3C,OAAOC,UAAUoD,eAAetD,kBAChCC,OAAOsD,YAAY,oBAAoB,EAAOV,QAAQW,MACtDvD,OAAOC,UAAUoD,eAAetD,mBAG9ByD,yBAA4BC,0BACxBlD,KAAO,OACTM,SAEAA,KAAO4C,kBAAkBC,YAC3B,MAAOC,cACEpD,YAIXA,KAAKM,KAAOA,KAAK8B,WAEVpC,MAGLJ,gBAAkBE,eAAML,YAAQO,4DAAO,SACnCN,UAAYD,OAAOC,UAAU2D,UAC7BH,kBAAoBxD,UAAU4D,QAAQ,2BACxCJ,mBACA9C,OAAOC,OAAOL,KAAMiD,yBAAyBC,0BAG3CnD,YAAcwD,uBAAaC,OAAO,CACpCC,KAAMC,eAAMC,KACZC,OAAO,IAEX7D,MAAM8D,aAEAC,MAAQ/D,MAAMG,UACd6D,KAAOD,MAAM,GACnBA,MAAME,GAAGC,sBAAYC,MAAM,CAACC,MAAOpE,SAC/BF,yBAAyBJ,OAAQM,MAAOC,SAG5C+D,KAAKK,iBAAiB,SAAUC,OACLA,EAAEC,OAAOhB,QAAQ,8BACpB,OACViB,SAAU,uBAAW9E,QAC3B+E,UAAUD,SAAS,0BAAc9E,SAAS,wBAAYA,SAEtDgF,OAAOL,iBAAiB,WAAW,SAASD,UAChB,cAApBA,MAAMnE,KAAKmE,MAAuB,OAC5B7D,KAAO6D,MAAMnE,KAAKA,KACxByE,OAAOC,IAAIC,QACXjE,QAAQC,IAAIL,MACZsE,SAASC,eAAe,sBAAsBC,UAAYxE,KAAKa,MAC/DyD,SAASC,eAAe,mBAAmBpE,MAAQF,KAAKwE,UAAUzE,UAGvE,QAKTkE,UAAY,SAASD,QAASS,WAAYC,UAE5CR,OAAOC,IAAMD,OAAOS,OACpBT,OAAOC,IAAIE,SAASO,MAAM,qCAEtBC,mBAAcC,gBAAOC,gEAEjBN,gBACC,iBAUDA,WAAa,+BAPZ,cACDA,WAAa,oCAEZ,YACDA,WAAa,8BAOrBO,MAAMH,SAAU,CACZI,OAAQ,OACRC,KAAS,OACTC,QAAS,gBACW,0BACA,oBAEpBC,KAAMpF,KAAKwE,UAAU,CACjBa,QAAS,YACTC,SAAUZ,aAGba,MAAK,SAASC,aACPA,SAASC,QAAU,KAAOD,SAASC,OAAS,WACrCD,SAASE,aAEd,IAAIC,MAAMH,SAASI,eAE5BL,MAAK,SAASC,UAEXxB,SAAWS,WAAa,8CADXe,SAGbtB,OAAOC,IAAI0B,SAASC,KAAO9B"}