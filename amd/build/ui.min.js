define("tiny_edusharing/ui",["exports","./common","./options","core/normalise","core/templates","tiny_edusharing/modal","core/modal_events","core/modal_factory","core/config"],(function(_exports,_common,_options,_normalise,_templates,_modal,_modal_events,_modal_factory,_config){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny edu-sharing Content configuration.
   *
   * @module      tiny_edusharing/commands
   * @copyright   2022 metaVentis GmbH <http://metaventis.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.handleAction=void 0,_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory),_config=_interopRequireDefault(_config);let openingSelection=null;_exports.handleAction=editor=>{openingSelection=editor.selection.getBookmark(),displayDialogue(editor)};const handleDialogueSubmission=async(editor,modal,data)=>{const form=(0,_normalise.getList)(modal.getRoot())[0].querySelector("form");if(!form)return void displayDialogue(editor,Object.assign({},data));const node=JSON.parse(form.querySelector('input[name="edusharing_node"]').value);if(console.log("node:"),console.log(node),!node)return void displayDialogue(editor,Object.assign({},data,{edusharing_node:node,invalidUrl:!0}));let style="";"none"!=node.alignment&&(style="float:"+node.alignment+";"),"folder"==node.mediatype&&(style="display:block;");let version="0";0==node.showlatest&&"undefined"!=node.version&&(version=node.version);node.title;let title=node.title||node.name,caption=node.caption||"",url=new URL(node.preview.url);url.searchParams.set("caption",caption),url.searchParams.set("object_url",node.objecturl),url.searchParams.set("mediatype",node.mediatype),url.searchParams.set("mimetype",node.mimetype),url.searchParams.set("window_version",version),url.searchParams.set("title",title);let img,width=Math.round(node.properties["ccm:width"])||600,height=Math.round(node.properties["ccm:height"])||400,ref=!1;"ref"==node.mediatype?ref=!0:(img=!0,url.searchParams.set("width",width.toString()),url.searchParams.set("height",height.toString()));const content=await(0,_templates.renderForPromise)("".concat(_common.component,"/content"),{edusharing_img:img,edusharing_ref:ref,edusharing_preview_src:url.toString(),edusharing_title:title.toString(),edusharing_caption:caption.toString(),edusharing_width:width.toString(),edusharing_height:height.toString()});editor.selection.moveToBookmark(openingSelection),editor.execCommand("mceInsertContent",!1,content.html),editor.selection.moveToBookmark(openingSelection)},getCurrentEdusharingData=currentEdusharing=>{const data={};let node;try{node=currentEdusharing.textContent}catch(error){return data}return data.node=node.toString(),data},displayDialogue=async function(editor){let data=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const selection=editor.selection.getNode(),currentEdusharing=selection.closest(".edusharing-placeholder");currentEdusharing&&Object.assign(data,getCurrentEdusharingData(currentEdusharing));const modal=await _modal_factory.default.create({type:_modal.default.TYPE,large:!0});modal.show();const $root=modal.getRoot(),root=$root[0];$root.on(_modal_events.default.save,((event,modal)=>{handleDialogueSubmission(editor,modal,data)})),root.addEventListener("click",(e=>{if(e.target.closest('[data-target="edusharing"]')){const repoUrl=(0,_options.getRepoUrl)(editor);open_repo(repoUrl,(0,_options.getRepoTarget)(editor),(0,_options.getCourseId)(editor)),window.addEventListener("message",(function(event){if("APPLY_NODE"==event.data.event){const node=event.data.data;window.win.close(),console.log(node),document.getElementById("edusharing-content").innerHTML=node.title,document.getElementById("edusharing_node").value=JSON.stringify(node)}}),!1)}}))},open_repo=function(repoUrl,repoTarget,courseId){window.win=window.open(),window.win.document.write("Loading edu-sharing ticket...");var fetchUrl="".concat(_config.default.wwwroot,"/lib/editor/tiny/plugins/edusharing/fetch.php");switch(repoTarget){case"search":default:repoTarget="/components/search";break;case"collections":repoTarget="/components/collections";break;case"workspace":repoTarget="/components/workspace/files"}fetch(fetchUrl,{method:"post",mode:"cors",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({useCase:"getTicket",courseid:courseId})}).then((function(response){if(response.status>=200&&response.status<300)return response.text();throw new Error(response.statusText)})).then((function(response){repoUrl+=repoTarget+"?reurl=WINDOW&applyDirectories=true&ticket="+response,window.win.location.href=repoUrl}))}}));

//# sourceMappingURL=ui.min.js.map