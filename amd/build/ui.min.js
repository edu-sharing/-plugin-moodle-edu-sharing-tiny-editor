define("tiny_edusharing/ui",["exports","./common","./options","core/templates","tiny_edusharing/modal","core/modal_events","core/modal_factory","./repository"],(function(_exports,_common,_options,_templates,_modal,_modal_events,_modal_factory,_repository){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Tiny edu-sharing Content configuration.
   *
   * @module      tiny_edusharing/commands
   * @copyright   2022 metaVentis GmbH <http://metaventis.com>
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.handleAction=void 0,_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory);let openingSelection=null;_exports.handleAction=editor=>{openingSelection=editor.selection.getBookmark(),displayDialogue(editor)};const handleDialogueSubmission=async editor=>{const nodeJson=window.document.getElementById("edusharing_node").value,node=JSON.parse(nodeJson),version=window.document.querySelector('input[name="eduVersion"]:checked').value,caption=window.document.getElementById("captionInput").value,alignment=window.document.querySelector('input[name="eduAlignment"]:checked').value,width=window.document.getElementById("eduWidth").value,height=window.document.getElementById("eduHeight").value;let style="";"none"!==alignment&&(style="float:"+node.alignment+";"),"folder"===node.mediatype&&(style="display:block;");let title=node.title||node.name,url=new URL(node.previewUrl);url.searchParams.set("caption",caption),url.searchParams.set("object_url",node.objectUrl),url.searchParams.set("mediatype",node.mediatype),url.searchParams.set("mimetype",node.mimetype),url.searchParams.set("window_version",version),url.searchParams.set("title",title);let img=!1,ref=!1;"ref"===node.mediatype?ref=!0:(img=!0,url.searchParams.set("width",width.toString()),url.searchParams.set("height",height.toString()));const content=await(0,_templates.renderForPromise)("".concat(_common.component,"/content"),{edusharingImg:img,edusharingRef:ref,edusharingPreviewSrc:url.toString(),edusharingTitle:title.toString(),edusharingCaption:caption.toString(),edusharingWidth:width.toString(),edusharingHeight:height.toString(),edusharingStyle:style});editor.selection.moveToBookmark(openingSelection),editor.execCommand("mceInsertContent",!1,content.html),editor.selection.moveToBookmark(openingSelection)},getCurrentEdusharingData=currentEdusharing=>{const data={};let node;try{node=currentEdusharing.textContent}catch(error){return data}return data.node=node.toString(),data},displayDialogue=async function(editor){let data=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const selection=editor.selection.getNode(),currentEdusharing=selection.closest(".edusharing-placeholder");currentEdusharing&&(window.console.log(currentEdusharing),Object.assign(data,getCurrentEdusharingData(currentEdusharing)));const modal=await _modal_factory.default.create({type:_modal.default.TYPE,large:!0,removeOnClose:!0});modal.show();const $root=modal.getRoot(),root=$root[0];$root.on(_modal_events.default.save,(()=>{handleDialogueSubmission(editor)})),root.addEventListener("click",(e=>{if(e.target.closest('[data-target="edusharing"]')){const repoUrl=(0,_options.getRepoUrl)(editor);openRepo(repoUrl,(0,_options.getRepoTarget)(editor),(0,_options.getCourseId)(editor)),window.addEventListener("message",(function(event){if("APPLY_NODE"===event.data.event){const node=event.data.data,width=Math.round(node.properties["ccm:width"][0])||600,height=Math.round(node.properties["ccm:height"][0])||400;window.win.close(),window.console.log(node),checkVersioning(node),window.document.getElementById("repoButtonContainer").classList.add("d-none"),window.document.getElementById("nodeOptionsForm").classList.remove("d-none"),window.document.getElementById("eduContentTitle").innerHTML=node.name||node.title,window.document.getElementById("eduPreviewImage").setAttribute("src",node.preview.url),initSizeCalculation(width,height),setNodeData(node),window.document.getElementById("eduSubmitButton").disabled=!1}}))}}))},initSizeCalculation=(width,height)=>{if(0===width||0===height)return;const aspectRatio=width/height,heightInput=window.document.getElementById("eduHeight"),widthInput=window.document.getElementById("eduWidth");widthInput.value=width,heightInput.value=height,widthInput.addEventListener("keyup",(event=>recalculateDimensions(event))),widthInput.addEventListener("change",(event=>recalculateDimensions(event))),heightInput.addEventListener("keyup",(event=>recalculateDimensions(event))),heightInput.addEventListener("change",(event=>recalculateDimensions(event)));const recalculateDimensions=event=>{"eduHeight"===event.target.id?widthInput.value=Math.round(heightInput.value*aspectRatio):heightInput.value=Math.round(widthInput.value/aspectRatio)}},checkVersioning=node=>{(node.aspects.includes("ccm:published")||node.aspects.includes("ccm:collection_io_reference"))&&window.document.querySelectorAll(".eduVersionRadio").forEach((item=>item.classList.add("d-none"))),window.document.getElementById("eduversion2").value=node.properties["cclom:version"][0]},setNodeData=node=>{const nodeData={mimetype:node.mimetype,mediatype:node.mediatype,title:node.title,objectUrl:node.objectUrl,name:node.name,previewUrl:node.preview.url};window.document.getElementById("edusharing_node").value=JSON.stringify(nodeData)},openRepo=(repoUrl,repoTarget,courseId)=>{switch(window.win=window.open(),window.win.document.write("Loading edu-sharing ticket..."),repoTarget){case"collections":repoTarget="/components/collections";break;case"workspace":repoTarget="/components/workspace/files";break;default:repoTarget="/components/search"}const ajaxParams={eduTicketStructure:{courseId:courseId}};(0,_repository.getTicket)(ajaxParams).then((response=>(repoUrl+=repoTarget+"?reurl=WINDOW&applyDirectories=true&ticket="+response.ticket,window.win.location.href=repoUrl,null))).fail((()=>window.document.write("Error loading ticket.")))}}));

//# sourceMappingURL=ui.min.js.map